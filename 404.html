<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông tin nhân sự</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">

  <!-- Card nhân sự -->
  <div id="employeeCard" class="bg-white shadow-lg rounded-xl p-6 max-w-md w-full text-center flex flex-col items-center">
    <img src="mock_logo_congty.png" alt="Logo" class="w-20 mb-4">
    <div id="employeeInfo"></div>
    
    <!-- QR code -->
    <div id="qrcode" class="mt-4 flex justify-center"></div>
    
    <!-- Buttons -->
    <div class="flex flex-col sm:flex-row gap-3 mt-6 w-full justify-center">
      <button id="btnShowQR" onclick="generateQR()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex-1 sm:flex-none">
        📱 Xuất QR
      </button>
      <button id="btnDownloadQR" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 hidden flex-1 sm:flex-none">
        ⬇️ Tải QR về
      </button>
      <button onclick="goBack()" 
              class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 flex-1 sm:flex-none">
        ⬅️ Quay lại danh sách
      </button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwZqC77F8HHIkFN9cfoo1zE1P1ixfS1LD6-qC_8PjcLAVjy7qGjbx4m68wCt5int3Qq/exec";
    let currentId = null;
    let currentQRCanvas = null;

    function formatDate(value) {
      if (!value) return "";
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      return d.toLocaleDateString("vi-VN");
    }

    function renderSheet(data) {
      const idFromUrl = window.location.pathname.split("/").pop();
      const emp = data.slice(1).find(row => String(row[0]) === idFromUrl);

      if (!emp) {
        document.getElementById("employeeInfo").innerHTML =
          `<p class="text-red-600">❌ Không tìm thấy nhân sự với ID: ${idFromUrl}</p>`;
        return;
      }

      const [id, name, dob, phone, start, position, department, avatar] = emp;
      currentId = id;

      document.getElementById("employeeInfo").innerHTML = `
        <img src="${avatar || "https://placehold.co/150x150"}" 
             alt="${name}" 
             class="w-32 h-32 object-cover rounded-full border-4 border-blue-600 mx-auto">
        <h2 class="text-xl font-semibold mt-2">${name}</h2>
        <p class="text-gray-600 text-sm mb-4">ID: ${id}</p>
        <div class="space-y-2 text-sm text-center w-full">
          <p><b>📅 Ngày sinh:</b> ${formatDate(dob)}</p>
          <p><b>📞 SĐT:</b> ${phone}</p>
          <p><b>🚀 Bắt đầu:</b> ${formatDate(start)}</p>
          <p><b>💼 Vị trí:</b> ${position}</p>
          <p><b>🏢 Phòng:</b> ${department}</p>
        </div>
      `;
    }

    function generateQR() {
      if (!currentId) return;

      const qrContainer = document.getElementById("qrcode");
      qrContainer.innerHTML = "";
      const url = `${window.location.origin}/employee-form/${currentId}`;

      QRCode.toCanvas(url, { width: 200 }, function (err, canvas) {
        if (!err) {
          qrContainer.appendChild(canvas);
          currentQRCanvas = canvas;
          document.getElementById("btnDownloadQR").classList.remove("hidden");
          document.getElementById("btnDownloadQR").onclick = () => downloadQR(currentId);
        }
      });
    }

    function downloadQR(id) {
      if (!currentQRCanvas) return;
      const link = document.createElement("a");
      link.download = `QR_${id}.png`;
      link.href = currentQRCanvas.toDataURL("image/png");
      link.click();
    }

    function goBack() {
      window.location.href = window.location.origin + "/employee-form/";
    }

    function loadData() {
      const old = document.getElementById("jsonpScript");
      if (old) old.remove();

      const script = document.createElement("script");
      script.id = "jsonpScript";
      script.src = SCRIPT_URL + "?callback=renderSheet&_ts=" + Date.now();
      document.body.appendChild(script);
    }

    loadData();
  </script>
</body>
</html>
